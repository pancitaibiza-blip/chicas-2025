'use client';

import { useState, useEffect, useCallback, useRef } from 'react';
// Aseg√∫rate de que esta ruta sea correcta en tu proyecto (src/types/fortnite-game.ts)
import { Card, League, Player, GameView } from '@/types/fortnite-game';

// Cartas especiales para la IA con m√°s vida
const IA_CARDS: Omit<Card, 'unlocked' | 'currentHp' | 'alive'>[] = [
  { id: 101, name: "IA Ram√≠rez", img: "https://s93.erome.com/5472/K3IRZbxx/Y8DPmT76.jpeg?v=1764825894", rarity: "common", atk: 60, def: 80, power: "Paso Firme Mejorado", attackType: "wind" },
  { id: 102, name: "IA Azulita", img: "https://s93.erome.com/5472/K3IRZbxx/0B8OzReu.jpeg?v=1764815871", rarity: "rare", atk: 70, def: 85, power: "Confeti √Åcido Doble", attackType: "fire" },
  { id: 103, name: "IA Tormenta", img: "https://s93.erome.com/5472/K3IRZbxx/7GmdJa3U.jpeg?v=1764802552", rarity: "epic", atk: 80, def: 75, power: "Torbellino Destructor", attackType: "wind" },
  { id: 104, name: "IA Fortaleza", img: "https://s93.erome.com/5472/K3IRZbxx/1FvcJ5u7.png?v=1764809177", rarity: "rare", atk: 60, def: 100, power: "Muralla Imbatible", attackType: "ice" },
  { id: 105, name: "IA Danza", img: "https://s93.erome.com/5472/K3IRZbxx/0VxSvgAl.jpeg?v=1764818017", rarity: "epic", atk: 75, def: 80, power: "Baile Mortal", attackType: "wind" },
  { id: 106, name: "IA Furia", img: "https://s93.erome.com/5472/K3IRZbxx/LsMURibY.jpeg?v=1764812622", rarity: "legendary", atk: 90, def: 70, power: "Ira Absoluta", attackType: "fire" },
  { id: 107, name: "IA Escudera", img: "https://s93.erome.com/5472/K3IRZbxx/9RweIpam.jpeg?v=1764813677", rarity: "common", atk: 55, def: 95, power: "Protecci√≥n Total", attackType: "ice" },
  { id: 108, name: "IA Asesina", img: "https://s206.erome.com/4699/lpRzYjBO/Z5Tc5k2v.jpeg?v=1745795818", rarity: "legendary", atk: 95, def: 60, power: "Golpe Aniquilador", attackType: "fire" },
  { id: 109, name: "IA Guardiana", img: "https://s206.erome.com/4699/lpRzYjBO/P9p2wv5y.jpeg?v=1745795818", rarity: "epic", atk: 50, def: 110, power: "Escudo Divino", attackType: "ice" },
  { id: 110, name: "IA √âLITE", img: "https://s206.erome.com/4699/lpRzYjBO/gU2HfmRY.jpeg?v=1745795818", rarity: "legendary", atk: 100, def: 65, power: "Tirano Supremo", attackType: "arcane" }
];

export const useFortniteGame = () => {
  const gameActiveRef = useRef(false);

  const [player, setPlayer] = useState<Player>({
    name: '',
    trophies: 0,
    diamonds: 100,
    league: {
      name: 'Bronce',
      min: 0,
      max: 199,
      badgeClass: 'bg-amber-600',
      iaMod: -20
    }
  });

  const [currentDeck, setCurrentDeck] = useState<number[]>([0, 3, 6]);
  const [playerCards, setPlayerCards] = useState<Card[]>([]);
  const [enemyCard, setEnemyCard] = useState<Card | null>(null);
  const [gameActive, setGameActive] = useState(false);
  const [playerTurn, setPlayerTurn] = useState(false);
  const [selectedPlayerCard, setSelectedPlayerCard] = useState<Card | null>(null);
  const [currentView, setCurrentView] = useState<GameView>('battle');
  const [battleLog, setBattleLog] = useState<string>('¬°Elige una carta de tu mazo para atacar!');

  const LEAGUES: League[] = [
    { name: "Bronce", min: 0, max: 199, badgeClass: "bg-amber-600", iaMod: -20 },
    { name: "Plata", min: 200, max: 399, badgeClass: "bg-gray-400", iaMod: 0 },
    { name: "Oro", min: 400, max: 599, badgeClass: "bg-yellow-500", iaMod: 20 },
    { name: "√âlite", min: 600, max: 799, badgeClass: "bg-purple-500", iaMod: 40 },
    { name: "Leyenda", min: 800, max: Infinity, badgeClass: "bg-gradient-to-r from-yellow-400 to-red-500", iaMod: 60 }
  ];

  const CARDS: Card[] = [
    { id: 0, name: "Ram√≠rez", img: "https://s93.erome.com/5472/K3IRZbxx/Y8DPmT76.jpeg?v=1764825894", rarity: "common", atk: 60, def: 50, power: "Paso Firme", attackType: "wind", unlocked: true, currentHp: 50, alive: true },
    { id: 1, name: "Azulita", img: "https://s93.erome.com/5472/K3IRZbxx/0B8OzReu.jpeg?v=1764815871", rarity: "rare", atk: 70, def: 55, power: "Confeti √Åcido", attackType: "fire", unlocked: true, currentHp: 55, alive: true },
    { id: 2, name: "Tormenta", img: "https://s93.erome.com/5472/K3IRZbxx/7GmdJa3U.jpeg?v=1764802552", rarity: "epic", atk: 80, def: 45, power: "Torbellino", attackType: "wind", unlocked: true, currentHp: 45, alive: true },
    { id: 3, name: "Fortaleza", img: "https://s93.erome.com/5472/K3IRZbxx/1FvcJ5u7.png?v=1764809177", rarity: "rare", atk: 60, def: 70, power: "Muralla", attackType: "ice", unlocked: true, currentHp: 70, alive: true },
    { id: 4, name: "Danza", img: "https://s93.erome.com/5472/K3IRZbxx/0VxSvgAl.jpeg?v=1764818017", rarity: "epic", atk: 75, def: 50, power: "Baile √âpico", attackType: "wind", unlocked: true, currentHp: 50, alive: true },
    { id: 5, name: "Furia", img: "https://s93.erome.com/5472/K3IRZbxx/LsMURibY.jpeg?v=1764812622", rarity: "legendary", atk: 90, def: 40, power: "Ira Incontenible", attackType: "fire", unlocked: true, currentHp: 40, alive: true },
    { id: 6, name: "Escudera", img: "https://s93.erome.com/5472/K3IRZbxx/9RweIpam.jpeg?v=1764813677", rarity: "common", atk: 55, def: 65, power: "Protecci√≥n", attackType: "ice", unlocked: true, currentHp: 65, alive: true },
    { id: 7, name: "Asesina", img: "https://s206.erome.com/4699/lpRzYjBO/Z5Tc5k2v.jpeg?v=1745795818", rarity: "legendary", atk: 95, def: 30, power: "Golpe Letal", attackType: "fire", unlocked: true, currentHp: 30, alive: true },
    { id: 8, name: "Guardiana", img: "https://s206.erome.com/4699/lpRzYjBO/P9p2wv5y.jpeg?v=1745795818", rarity: "epic", atk: 50, def: 80, power: "Escudo Energ√©tico", attackType: "ice", unlocked: true, currentHp: 80, alive: true },
    { id: 9, name: "IA √âLITE", img: "https://s206.erome.com/4699/lpRzYjBO/gU2HfmRY.jpeg?v=1745795818", rarity: "legendary", atk: 100, def: 35, power: "Tirano", attackType: "arcane", unlocked: true, currentHp: 35, alive: true },
    { id: 10, name: "Sellamara Gemelas", img: "https://s326.erome.com/5139/YBnb1NTO/R8jmYVqr.jpeg?v=1750357395", rarity: "legendary", atk: 120, def: 60, power: "Desaf√≠o Final", attackType: "arcane", unlocked: false, currentHp: 60, alive: true },
    { id: 11, name: "Ice Spice", img: "https://s205.erome.com/4802/VjncXAEk/DLR6qZLg.jpeg?v=1746865143", rarity: "legendary", atk: 150, def: 70, power: "Colaboraci√≥n Especial", attackType: "ice", unlocked: false, currentHp: 70, alive: true }
  ];

  const [cards, setCards] = useState<Card[]>(CARDS.map(c => ({ ...c, currentHp: c.def, alive: true }))); // Inicializar con todas las cartas

  // Inicializar juego
  useEffect(() => {
    const savedPlayerName = localStorage.getItem('playerName');
    const savedTrophies = parseInt(localStorage.getItem('trophies') || '0');
    const savedDiamonds = parseInt(localStorage.getItem('diamonds') || '100');
    const savedDeck = JSON.parse(localStorage.getItem('currentDeck') || '[0, 3, 6]');

    let playerName = savedPlayerName;
    if (!savedPlayerName) {
      playerName = prompt("¬øC√≥mo te llamas, jugador/a?") || "Jugador";
      localStorage.setItem('playerName', playerName);
    }

    // Resetear diamantes diarios
    const today = new Date().toDateString();
    const lastDiamondClaim = localStorage.getItem('lastDiamondClaim');
    if (lastDiamondClaim !== today) {
      localStorage.setItem('diamonds', '100');
      localStorage.setItem('lastDiamondClaim', today);
    }

    // Crear copia de las cartas y cargar estado
    const savedCards = JSON.parse(localStorage.getItem('cards') || '{}');
    const initialCards = CARDS.map(card => {
      // Si est√° guardada, usa el estado guardado, sino, el valor por defecto
      const unlocked = savedCards[card.id] !== undefined ? savedCards[card.id] : card.unlocked;
      return { ...card, unlocked, currentHp: card.def, alive: true };
    });

    setCards(initialCards);

    const league = LEAGUES.find(l => savedTrophies >= l.min && savedTrophies <= l.max) || LEAGUES[0];

    setPlayer({
      name: playerName,
      trophies: savedTrophies,
      diamonds: savedDiamonds,
      league
    });

    setCurrentDeck(savedDeck);
  }, []);

  // Actualizar liga cuando cambian los trofeos
  useEffect(() => {
    const newLeague = LEAGUES.find(l => player.trophies >= l.min && player.trophies <= l.max) || LEAGUES[0];
    if (newLeague.name !== player.league.name) {
      setPlayer(prev => ({ ...prev, league: newLeague }));
    }
  }, [player.trophies, player.league.name, LEAGUES]);

  const updatePlayer = (updates: Partial<Player>) => {
    setPlayer(prev => {
      const newPlayer = { ...prev, ...updates };
      localStorage.setItem('trophies', newPlayer.trophies.toString());
      localStorage.setItem('diamonds', newPlayer.diamonds.toString());
      return newPlayer;
    });
  };

  const saveCollection = () => {
    const state: Record<number, boolean> = {};
    cards.forEach(card => {
      state[card.id] = card.unlocked;
    });
    // Se mantiene la carta 10 bloqueada por defecto en el estado guardado si no se ha comprado
    localStorage.setItem('cards', JSON.stringify(state));
  };

  const startBattle = () => {
    const newPlayerCards: Card[] = [];
    currentDeck.forEach(id => {
      // Buscar la carta en el estado 'cards' y verificar si est√° desbloqueada
      const card = cards.find(c => c.id === id && c.unlocked);
      if (card) {
        newPlayerCards.push({ ...card, currentHp: card.def, alive: true });
      }
    });

    if (newPlayerCards.length === 0) {
      alert('¬°Tu mazo est√° vac√≠o o las cartas est√°n bloqueadas! Ve a "Mazo" y arma tu mazo.');
      return;
    }

    // Seleccionar una carta aleatoria de la IA
    const randomIACardTemplate = IA_CARDS[Math.floor(Math.random() * IA_CARDS.length)];
    // Asignar propiedades de batalla a la carta de la IA
    const iaCard: Card = { 
        ...randomIACardTemplate, 
        unlocked: true, // La IA siempre tiene sus cartas desbloqueadas
        currentHp: randomIACardTemplate.def, 
        alive: true 
    };

    // Resetear todos los estados de batalla
    setPlayerCards(newPlayerCards);
    setEnemyCard(iaCard);
    setGameActive(true);
    gameActiveRef.current = true; // Actualizar la referencia
    setPlayerTurn(true); // El jugador ataca primero ahora
    setSelectedPlayerCard(newPlayerCards[0]);
    setBattleLog('¬°Comienza la batalla! Elige tu acci√≥n: atacar o defenderte.');
  };

  const executeIATurn = useCallback((playerDefenseBoost = 0) => {
    if (!gameActiveRef.current || !selectedPlayerCard || !enemyCard) {
      return;
    }

    setPlayerTurn(false);

    setBattleLog(`¬°La IA ataca a ${selectedPlayerCard.name}!`);

    // Calcular da√±o
    const baseDamage = Math.max(5, enemyCard.atk - Math.floor((selectedPlayerCard.def + playerDefenseBoost) * 0.3));
    const modifier = player.league.iaMod / 100;
    const damage = Math.round(baseDamage * (1 + modifier));

    setTimeout(() => {
      if (!gameActiveRef.current) return;

      const newSelectedCard: Card = { ...selectedPlayerCard, currentHp: Math.max(0, (selectedPlayerCard.currentHp || 0) - damage) };
      setSelectedPlayerCard(newSelectedCard);

      const updatedPlayerCards = playerCards.map(card =>
        card.id === selectedPlayerCard.id ? newSelectedCard : card
      );
      setPlayerCards(updatedPlayerCards);

      if (newSelectedCard.currentHp <= 0) {
        newSelectedCard.alive = false;
        setBattleLog(`¬°${selectedPlayerCard.name} fue eliminada!`);

        const aliveCards = updatedPlayerCards.filter(c => c.alive);
        if (aliveCards.length === 0) {
          updatePlayer({ trophies: Math.max(0, player.trophies - 15) });
          const msg = `Perdiste 15 trofeos.<br>Total: ${Math.max(0, player.trophies - 15)} trofeos.`;
          showEndScreen(false, msg);
          return;
        }
        // Seleccionar la siguiente carta viva
        setSelectedPlayerCard(aliveCards[0]);
      }

      setTimeout(() => {
        if (gameActiveRef.current) {
          setPlayerTurn(true);
          setBattleLog('¬°Tu turno! Elige tu acci√≥n: atacar o defenderte.');
        }
      }, 1000);
    }, 1000);
  }, [selectedPlayerCard, enemyCard, playerCards, player.league.iaMod, player.trophies]);

  const executePlayerAttack = useCallback((card: Card) => {
    if (!gameActiveRef.current || !playerTurn || !enemyCard) {
      return;
    }

    setBattleLog(`¬°${card.name} usa <strong>${card.power}</strong>!`);

    // Calcular da√±o
    const damage = Math.max(5, card.atk - Math.floor(enemyCard.def * 0.3));

    setTimeout(() => {
      if (!gameActiveRef.current) return;

      const newEnemyCard: Card = { ...enemyCard, currentHp: Math.max(0, (enemyCard.currentHp || 0) - damage) };
      setEnemyCard(newEnemyCard);

      if (newEnemyCard.currentHp <= 0) {
        setBattleLog(`¬°${card.name} derrot√≥ a la IA!`);
        setTimeout(() => {
          if (gameActiveRef.current) {
            updatePlayer({ trophies: player.trophies + 30 });
            const msg = `¬°Ganaste 30 trofeos!<br>Total: ${player.trophies + 30} trofeos.`;
            showEndScreen(true, msg);
          }
        }, 1500);
      } else {
        setBattleLog(prev => prev + `<br>¬°Turno de la IA!`);
        setTimeout(() => {
          if (gameActiveRef.current) {
            executeIATurn();
          }
        }, 1500);
      }
    }, 1000);
  }, [playerTurn, enemyCard, player.trophies, executeIATurn]);

  const executePlayerDefend = useCallback((card: Card) => {
    if (!gameActiveRef.current || !playerTurn || !selectedPlayerCard) {
      return;
    }

    setBattleLog(`¬°${card.name} se defiende!`);

    // Aumentar la defensa temporalmente para el pr√≥ximo ataque
    const defenseBoost = Math.floor(card.def * 0.5);

    setTimeout(() => {
      setBattleLog(prev => prev + `<br>¬°${card.name} aument√≥ su defensa en ${defenseBoost} puntos!`);
      setBattleLog(prev => prev + `<br>¬°Turno de la IA!`);

      setTimeout(() => {
        if (gameActiveRef.current) {
          executeIATurn(defenseBoost);
        }
      }, 1500);
    }, 1000);
  }, [playerTurn, selectedPlayerCard, executeIATurn]);

  // Funci√≥n simplificada para el ataque del jugador
  const attackWithSelected = () => {
    if (selectedPlayerCard) {
      executePlayerAttack(selectedPlayerCard);
    }
  };

  // Funci√≥n simplificada para la defensa del jugador
  const defendWithSelected = () => {
    if (selectedPlayerCard) {
      executePlayerDefend(selectedPlayerCard);
    }
  };

  const showEndScreen = (isWin: boolean, message: string) => {
    setGameActive(false);
    gameActiveRef.current = false;
    if (isWin) {
      setBattleLog(`
        <div class="text-center">
          <div class="relative">
            <div class="absolute inset-0 overflow-hidden">
              <div class="confetti absolute top-0 left-1/4 w-2 h-2 bg-yellow-400 rounded-full animate-confetti-1"></div>
              <div class="confetti absolute top-0 right-1/4 w-2 h-2 bg-red-400 rounded-full animate-confetti-2"></div>
              <div class="confetti absolute top-4 left-1/3 w-2 h-2 bg-blue-400 rounded-full animate-confetti-3"></div>
              <div class="confetti absolute top-4 right-1/3 w-2 h-2 bg-green-400 rounded-full animate-confetti-4"></div>
              <div class="confetti absolute top-8 left-1/2 w-2 h-2 bg-purple-400 rounded-full animate-confetti-5"></div>
              <div class="confetti absolute top-8 right-1/2 w-2 h-2 bg-pink-400 rounded-full animate-confetti-6"></div>
            </div>
            <div class="relative z-10">
              <div class="text-6xl mb-4 animate-bounce">üéâ</div>
              <h3 class="text-4xl font-bold text-yellow-400 mb-4 animate-pulse">¬°VICTORIA!</h3>
              <div class="text-2xl text-green-400 mb-4">¬°Has derrotado a la IA!</div>
              <p class="text-lg text-white mb-4">${message}</p>
              <div class="text-4xl animate-bounce">üèÜ</div>
              <div class="text-xl mt-4 text-yellow-300 font-bold">¬°GANASTE!</div>
            </div>
          </div>
        </div>
        <style>
          @keyframes confetti-1 {
            0% { transform: translateY(0) rotate(0deg); opacity: 1; }
            100% { transform: translateY(100px) rotate(360deg); opacity: 0; }
          }
          @keyframes confetti-2 {
            0% { transform: translateY(0) rotate(0deg); opacity: 1; }
            100% { transform: translateY(120px) rotate(-360deg); opacity: 0; }
          }
          @keyframes confetti-3 {
            0% { transform: translateY(0) rotate(0deg); opacity: 1; }
            100% { transform: translateY(90px) rotate(180deg); opacity: 0; }
          }
          @keyframes confetti-4 {
            0% { transform: translateY(0) rotate(0deg); opacity: 1; }
            100% { transform: translateY(110px) rotate(-180deg); opacity: 0; }
          }
          @keyframes confetti-5 {
            0% { transform: translateY(0) rotate(0deg); opacity: 1; }
            100% { transform: translateY(130px) rotate(270deg); opacity: 0; }
          }
          @keyframes confetti-6 {
            0% { transform: translateY(0) rotate(0deg); opacity: 1; }
            100% { transform: translateY(80px) rotate(-270deg); opacity: 0; }
          }
          .animate-confetti-1 {
            animation: confetti-1 2s ease-out forwards;
          }
          .animate-confetti-2 {
            animation: confetti-2 2.2s ease-out forwards;
          }
          .animate-confetti-3 {
            animation: confetti-3 1.8s ease-out forwards;
          }
          .animate-confetti-4 {
            animation: confetti-4 2.4s ease-out forwards;
          }
          .animate-confetti-5 {
            animation: confetti-5 1.6s ease-out forwards;
          }
          .animate-confetti-6 {
            animation: confetti-6 2.6s ease-out forwards;
          }
        </style>
      `);
    } else {
      setBattleLog(`
        <div class="text-center">
          <div class="text-4xl mb-4">üíÄ</div>
          <h3 class="text-3xl font-bold text-red-500 mb-4">DERROTA</h3>
          <div class="text-xl text-red-400 mb-4">La IA te ha derrotado</div>
          <p class="text-lg text-white mb-4">${message}</p>
          <div class="text-2xl">üíî</div>
        </div>
      `);
    }
  };

  const exitBattle = () => {
    setGameActive(false);
    gameActiveRef.current = false;
    setPlayerCards([]);
    setEnemyCard(null);
    setSelectedPlayerCard(null);
    setPlayerTurn(false);
    setCurrentView('collection'); // Vuelve a la vista de colecci√≥n o la que desees
  };

  const addToDeck = (cardId: number) => {
    if (currentDeck.length >= 3) {
      alert('Tu mazo solo puede tener 3 cartas.');
      return;
    }
    if (!currentDeck.includes(cardId)) {
      const newDeck = [...currentDeck, cardId];
      setCurrentDeck(newDeck);
      localStorage.setItem('currentDeck', JSON.stringify(newDeck));
    }
  };

  const removeFromDeck = (cardId: number) => {
    const newDeck = currentDeck.filter(id => id !== cardId);
    setCurrentDeck(newDeck);
    localStorage.setItem('currentDeck', JSON.stringify(newDeck));
  };

  const saveDeck = () => {
    if (currentDeck.length !== 3) {
      alert('¬°Tu mazo debe tener exactamente 3 cartas!');
      return;
    }
    localStorage.setItem('currentDeck', JSON.stringify(currentDeck));
    alert('¬°Mazo guardado!');
  };

  const buyItem = (itemId: string, cost: number) => {
    if (player.diamonds >= cost) {
      updatePlayer({ diamonds: player.diamonds - cost });
      // L√≥gica de desbloqueo de cartas/items
      if (itemId.startsWith('card_')) {
        const cardIdToUnlock = parseInt(itemId.split('_')[1]);
        setCards(prevCards => prevCards.map(c =>
          c.id === cardIdToUnlock ? { ...c, unlocked: true } : c
        ));
        // Guardar el estado desbloqueado
        const state: Record<number, boolean> = {};
        cards.forEach(card => {
            state[card.id] = card.unlocked;
        });
        state[cardIdToUnlock] = true;
        localStorage.setItem('cards', JSON.stringify(state));
      }
      return true;
    }
    return false;
  };

  const updateRanking = () => {
    let rankings: { name: string, trophies: number }[] = JSON.parse(localStorage.getItem('rankings') || '[]');

    const existingIndex = rankings.findIndex(r => r.name === player.name);
    if (existingIndex >= 0) {
      rankings[existingIndex].trophies = player.trophies;
    } else {
      rankings.push({ name: player.name, trophies: player.trophies });
    }

    rankings.sort((a, b) => b.trophies - a.trophies);
    rankings = rankings.slice(0, 10);
    localStorage.setItem('rankings', JSON.stringify(rankings));

    return rankings;
  };

  return {
    player,
    currentDeck,
    playerCards,
    enemyCard,
    gameActive,
    playerTurn,
    selectedPlayerCard,
    currentView,
    battleLog,
    cards,
    LEAGUES,
    setCurrentView,
    startBattle,
    attackWithSelected,
    defendWithSelected,
    exitBattle,
    addToDeck,
    removeFromDeck,
    saveDeck,
    buyItem,
    updateRanking,
    saveCollection,
    setSelectedPlayerCard,
    setBattleLog
  };
};
